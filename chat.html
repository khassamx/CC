<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat Multiusuario</title>
  <style>
    body { font-family: Arial; background:#111; color:white; display:flex; height:100vh; margin:0; }
    #container { display:flex; flex:1; }
    #sidebar { width:250px; background:#222; padding:15px; border-right:1px solid #444; }
    #sidebar h3 { color:skyblue; margin-top:0; }
    #user-list { list-style:none; padding:0; }
    #user-list li { padding:5px 0; border-bottom:1px dotted #333; }

    #main-chat { flex:1; display:flex; flex-direction:column; }
    header { background:#222; padding:15px; text-align:center; }
    #chat-box { flex:1; overflow-y:auto; padding:15px; background:#1a1a1a; }

    .mensaje, .status { margin:5px 0; padding:8px; border-radius:8px; }
    .mensaje { background:#333; }
    .status { background:#4a4; color:white; text-align:center; } /* Mensajes de sistema */
    .system { background:#555; color:yellow; } /* Respuestas de comandos */
    
    .usuario { font-weight:bold; color:lightgreen; }
    .rango { font-size:12px; color:skyblue; margin-left:5px; }

    footer { display:flex; background:#222; padding:10px; align-items:center; }
    #mensajeInput { flex:1; padding:10px; border:none; border-radius:8px; font-size:16px; }
    #media-upload { display:none; }
    #upload-button { background:orange; margin:0 5px; }
    #enviar-button { background:lightgreen; }
    #typing-status { font-size:12px; color:#888; padding:5px 15px; height:15px; }
    
    /* Estilos para Media */
    .media-content { max-width: 100%; max-height: 200px; display: block; margin-top: 5px; border-radius: 5px; }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
        <h3 id="bienvenida"></h3>
        <p id="rango"></p>
        <h4>Usuarios Conectados:</h4>
        <ul id="user-list"></ul>
    </div>

    <div id="main-chat">
        <header>
            <h1>Chat Multiusuario</h1>
        </header>
        <div id="chat-box"></div>
        <div id="typing-status"></div>
        <footer>
            <input type="file" id="media-upload" accept="image/*,video/*">
            <button id="upload-button" onclick="document.getElementById('media-upload').click()">📷 Media</button>
            <input type="text" id="mensajeInput" placeholder="Escribe un mensaje o /comando...">
            <button id="enviar-button" onclick="enviarMensaje()">Enviar</button>
        </footer>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Parámetros de URL
    const params = new URLSearchParams(window.location.search);
    const usuario = params.get("usuario") || "Invitado";
    const rango = params.get("rango") || "Sin rango";

    // Elementos DOM
    document.getElementById("bienvenida").textContent = `Hola ${usuario}!`;
    document.getElementById("rango").textContent = `Tu rango: ${rango}`;
    const chatBox = document.getElementById("chat-box");
    const userList = document.getElementById("user-list");
    const mensajeInput = document.getElementById("mensajeInput");
    const typingStatus = document.getElementById("typing-status");
    const mediaUpload = document.getElementById("media-upload");
    const uploadButton = document.getElementById("upload-button");

    const socket = io();
    let typingTimeout;

    // --- Funciones de Renderizado ---
    function appendMessage(data) {
        const div = document.createElement("div");
        div.classList.add(data.tipo === 'text' ? 'mensaje' : data.tipo);

        if (data.tipo === 'text') {
            div.innerHTML = `<span class="rango">[${data.rango}]</span><span class="usuario">${data.usuario}:</span> ${data.texto}`;
        } else if (data.tipo === 'media') {
            // Manejo de Fotos y Videos
            const mediaTag = data.mimeType.startsWith('image/') 
                ? `<img src="${data.url}" class="media-content" alt="Imagen enviada">` 
                : `<video src="${data.url}" class="media-content" controls></video>`;

            div.innerHTML = `<span class="rango">[${data.rango}]</span><span class="usuario">${data.usuario}:</span> Enviado multimedia<br>${mediaTag}`;
        } else if (data.tipo === 'status') {
             div.innerHTML = `⚠️ ${data.texto}`;
        } else if (data.tipo === 'system') {
             div.innerHTML = `[SISTEMA]: ${data.texto}`;
        }

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function updateUsers(users) {
        userList.innerHTML = '';
        users.forEach(u => {
            const li = document.createElement('li');
            li.textContent = `${u.usuario} [${u.rango}]`;
            userList.appendChild(li);
        });
    }

    // --- Conexión y Eventos de Socket.io ---

    socket.on("connect", () => {
        // Envía el evento JOIN al servidor con los datos del usuario
        socket.emit("join", { usuario, rango });
    });

    socket.on("update_users", updateUsers); // Recibe lista de usuarios

    socket.on("mensaje", appendMessage); // Recibe mensajes de texto/media

    socket.on("server_message", appendMessage); // Recibe mensajes de status/comando

    // Manejo de "Quién está escribiendo"
    socket.on("typing", (data) => {
        typingStatus.textContent = data.isTyping ? `${data.usuario} está escribiendo...` : '';
    });
    
    // --- Lógica de Input ---

    // 1. Detección de Escritura
    mensajeInput.addEventListener("input", () => {
        socket.emit("typing", true); // Notificar que estamos escribiendo
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit("typing", false); // Notificar que hemos parado de escribir
        }, 1500); // 1.5 segundos de pausa
    });

    // 2. Envío de Mensajes (Texto y Comandos)
    function enviarMensaje() {
        const texto = mensajeInput.value.trim();
        if (!texto) return;

        // Limpiar el estado de escritura
        clearTimeout(typingTimeout);
        socket.emit("typing", false);

        socket.emit("mensaje", { texto });
        mensajeInput.value = "";
    }
    
    // 3. Envío de Media (Fotos/Videos)
    mediaUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // **CRÍTICO: Convertir archivo a base64 para enviarlo por socket.io**
        const reader = new FileReader();
        reader.onload = (event) => {
            socket.emit("mensaje", { 
                texto: 'Archivo adjunto', // Texto dummy para el servidor
                tipo: 'media', 
                url: event.target.result, 
                mimeType: file.type 
            });
            mediaUpload.value = ''; // Limpiar input de archivo
        };
        reader.readAsDataURL(file);
    });


    // Evento ENTER y Botón
    document.getElementById("enviar-button").addEventListener("click", enviarMensaje);
    mensajeInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault(); // Evitar salto de línea
        enviarMensaje();
      }
    });
  </script>
</body>
</html>