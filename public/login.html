<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Login de Acceso</title>
    <link rel="stylesheet" href="login.css">
</head>
<body>
    <div id="login-container">
        <h2>Ingreso al Chat</h2>
        <input type="text" id="usuario" placeholder="Usuario" autocomplete="username">
        <input type="password" id="password" placeholder="Contraseña" autocomplete="current-password">
        <p id="mensaje">Escribe tus credenciales...</p>
    </div>

    <script>
        // --- Lógica del Tema Automático ---
        if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
            document.body.classList.add('dark');
        } else {
            document.body.classList.add('light');
        }
        
        // --- Lógica de Login ---
        const inputUsuario = document.getElementById("usuario");
        const inputPassword = document.getElementById("password");
        const mensaje = document.getElementById("mensaje");
        let timer;
        let isRedirecting = false;

        async function verificarUsuario() {
            if (isRedirecting) return;

            const usuario = inputUsuario.value.trim();
            const password = inputPassword.value.trim();

            if (usuario.length === 0 || password.length === 0) {
                mensaje.textContent = "Ingresa usuario y contraseña...";
                mensaje.style.color = "white";
                return;
            }
            
            mensaje.textContent = "Verificando...";
            mensaje.style.color = "yellow";

            try {
                const res = await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ usuario, password })
                });
                const data = await res.json();

                if(data.ok){
                    isRedirecting = true;
                    mensaje.textContent = `✔ ¡Bienvenido ${data.user.nombre}! Entrando...`;
                    mensaje.style.color = "lightgreen";
                    
                    // CRÍTICO: Redirecciona al nuevo archivo principal (index.html)
                    localStorage.setItem("userProfile", JSON.stringify(data.user)); 
                    
                    setTimeout(() => {
                        window.location.href = "index.html"; 
                    }, 500);
                } else {
                    mensaje.textContent = "❌ Usuario o contraseña incorrecta.";
                    mensaje.style.color = "red";
                }
            } catch (error) {
                mensaje.textContent = "❌ Error de conexión con el servidor.";
                mensaje.style.color = "red";
                console.error("Error de Fetch:", error);
            }
        }
        
        // Login Automático al escribir
        function handleInput() {
            clearTimeout(timer);
            if (inputUsuario.value.trim().length > 0 && inputPassword.value.trim().length > 0) {
                // Pequeña espera para evitar enviar peticiones por cada tecla
                timer = setTimeout(verificarUsuario, 600); 
            }
        }
        
        inputUsuario.addEventListener("input", handleInput);
        inputPassword.addEventListener("input", handleInput);
        
        // Login Inmediato al presionar Enter
        inputPassword.addEventListener("keypress", (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(timer);
                verificarUsuario();
            }
        });
    </script>
</body>
</html>