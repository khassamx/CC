<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Login de Acceso</title>
    <style>
        body { font-family: Arial; display:flex; justify-content:center; align-items:center; height:100vh; background:#111; color:white; }
        .login-box { background:#222; padding:30px; border-radius:15px; text-align:center; box-shadow:0 0 10px #000; }
        input { padding:10px; border:none; border-radius:8px; margin-top:10px; width:100%; font-size:16px; box-sizing: border-box;}
        #mensaje { margin-top:10px; font-weight: bold; height: 20px;}
    </style>
</head>
<body>
    <div class="login-box">
        <h2>Ingresar al Chat</h2>
        <input type="text" id="usuario" placeholder="Usuario" autocomplete="username">
        <input type="password" id="password" placeholder="Contraseña" autocomplete="current-password">
        <p id="mensaje">Escribe tus credenciales...</p>
    </div>

    <script>
        const inputUsuario = document.getElementById("usuario");
        const inputPassword = document.getElementById("password");
        const mensaje = document.getElementById("mensaje");
        let timer;
        let isRedirecting = false;

        async function verificarUsuario() {
            if (isRedirecting) return;

            const usuario = inputUsuario.value.trim();
            const password = inputPassword.value.trim();

            if (usuario.length === 0 || password.length === 0) {
                mensaje.textContent = "Ingresa usuario y contraseña...";
                mensaje.style.color = "white";
                return;
            }
            
            mensaje.textContent = "Verificando...";
            mensaje.style.color = "yellow";

            try {
                const res = await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ usuario, password })
                });
                const data = await res.json();

                if(data.ok){
                    isRedirecting = true;
                    mensaje.textContent = `✔ ¡Bienvenido ${data.user.nombre}! Entrando...`;
                    mensaje.style.color = "lightgreen";
                    
                    // Usamos localStorage para persistencia
                    localStorage.setItem("userProfile", JSON.stringify(data.user)); 
                    
                    setTimeout(() => {
                        window.location.href = "chat.html";
                    }, 500);
                } else {
                    mensaje.textContent = "❌ Usuario o contraseña incorrecta.";
                    mensaje.style.color = "red";
                }
            } catch (error) {
                mensaje.textContent = "❌ Error de conexión con el servidor.";
                mensaje.style.color = "red";
                console.error("Error de Fetch:", error);
            }
        }
        
        // Login Automático (sin necesidad de Enter)
        function handleInput() {
            clearTimeout(timer);
            // Solo intenta la verificación si ambos campos tienen texto
            if (inputUsuario.value.trim().length > 0 && inputPassword.value.trim().length > 0) {
                timer = setTimeout(verificarUsuario, 600); 
            }
        }
        
        inputUsuario.addEventListener("input", handleInput);
        inputPassword.addEventListener("input", handleInput);
        
        // Login Inmediato al presionar Enter
        inputPassword.addEventListener("keypress", (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(timer);
                verificarUsuario();
            }
        });
    </script>
</body>
</html>