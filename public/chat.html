<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <style>
    body { font-family: Arial; background:#111; color:white; display:flex; height:100vh; margin:0; }
    #container { display:flex; flex:1; }
    #sidebar { width:250px; background:#222; padding:15px; border-right:1px solid #444; }
    #main-chat { flex:1; display:flex; flex-direction:column; }
    header { background:#222; padding:15px; display:flex; align-items:center; }
    #foto-header { width:50px; height:50px; border-radius:50%; margin-right:10px; object-fit: cover;}

    #chat-box { flex:1; overflow-y:auto; padding:15px; background:#1a1a1a; }
    .mensaje, .status, .system { margin:5px 0; padding:8px; border-radius:8px; }
    .mensaje { background:#333; }
    .status { background:#4a4; color:white; text-align:center; }
    .system { background:#555; color:yellow; }

    .msg-header { font-weight:bold; font-size:1.1em; display:flex; align-items:center; margin-bottom:2px;} 
    .msg-photo { width:30px; height:30px; border-radius:50%; object-fit: cover; margin-right: 8px;}
    .rango { font-size:12px; color:skyblue; margin-right:5px; }
    .usuario { color:lightgreen; }

    /* Lista de Usuarios */
    #user-list { list-style: none; padding: 0; }
    #user-list li { display: flex; align-items: center; padding: 5px 0; border-bottom: 1px dotted #333; }
    .user-photo-list { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px; }

    footer { display:flex; background:#222; padding:10px; }
    input { flex:1; padding:10px; border:none; border-radius:8px; font-size:16px; }
    button { margin-left:10px; padding:10px 15px; border:none; border-radius:8px; background:lightgreen; cursor:pointer; }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
        <a href="perfil.html">Configurar Perfil</a>
        <h4>Usuarios Conectados:</h4>
        <ul id="user-list"></ul>
    </div>

    <div id="main-chat">
        <header>
            <img id="foto-header" src="default.png">
            <div>
              <h1 id="bienvenida"></h1>
              <h4 id="rango"></h4>
            </div>
        </header>

        <div id="chat-box"></div>

        <footer>
            <input type="text" id="mensajeInput" placeholder="Escribe un mensaje o /comando...">
            <button id="enviar-button">Enviar</button>
        </footer>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const perfil = JSON.parse(localStorage.getItem("perfilUsuario"));
    if(!perfil) window.location.href = "login.html"; // Seguridad

    // Cargar perfil en el header
    document.getElementById("bienvenida").textContent = perfil.nombre;
    document.getElementById("rango").textContent = "Rango: " + perfil.rango;
    document.getElementById("foto-header").src = perfil.foto;

    const chatBox = document.getElementById("chat-box");
    const userList = document.getElementById("user-list");
    const mensajeInput = document.getElementById("mensajeInput");
    const enviarButton = document.getElementById("enviar-button");
    const socket = io();

    // --- Funciones de Renderizado ---
    function appendMessage(data) {
        const div = document.createElement("div");
        div.classList.add(data.tipo === 'text' ? 'mensaje' : data.tipo);

        if (data.tipo === 'text') {
            div.innerHTML = `
                <span class="msg-header">
                    <img src="${data.foto}" class="msg-photo">
                    <span class="rango">[${data.rango}]</span>
                    <span class="usuario">${data.nombre}:</span>
                </span>
                ${data.texto}
            `;
        } else if (data.tipo === 'status') {
             div.innerHTML = `⚠️ ${data.texto}`;
        } else if (data.tipo === 'system') {
             div.innerHTML = `[SISTEMA]: ${data.texto}`;
        }

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function updateUsers(users) {
        userList.innerHTML = '';
        users.forEach(u => {
            const li = document.createElement('li');
            li.innerHTML = `
                <img src="${u.foto}" class="user-photo-list">
                <span>${u.nombre} [${u.rango}]</span>
            `;
            userList.appendChild(li);
        });
    }

    // --- Lógica de Envío ---
    function enviarMensaje() {
      const texto = mensajeInput.value.trim();
      if (!texto) return;
      socket.emit("mensaje", { texto });
      mensajeInput.value = "";
    }

    // --- Conexión y Recepción ---
    socket.on("connect", () => {
        // 1. CRÍTICO: Envía el PERFIL COMPLETO al servidor
        socket.emit("join", perfil);
    });

    socket.on("update_users", updateUsers); 
    socket.on("mensaje", appendMessage); 
    socket.on("server_message", appendMessage);

    // Eventos de Input
    enviarButton.addEventListener("click", enviarMensaje);
    mensajeInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault(); 
        enviarMensaje();
      }
    });

    // Escuchar el evento de almacenamiento (para actualizar si perfil.html lo cambia)
    window.addEventListener('storage', (e) => {
        if (e.key === 'perfilUsuario') {
            const newPerfil = JSON.parse(e.newValue);
            if(newPerfil) {
                // Actualizar la UI del chat local
                document.getElementById("bienvenida").textContent = newPerfil.nombre;
                document.getElementById("rango").textContent = "Rango: " + newPerfil.rango;
                document.getElementById("foto-header").src = newPerfil.foto;
                // Notificar a todos en el chat que mi perfil cambió
                socket.emit("profile_update", newPerfil); 
            }
        }
    });
  </script>
</body>
</html>